#!/bin/bash

function log {
    echo "> ${@}"
}

log "generating proto shizzles"
protoc --proto_path=./ -I../golpje/ --go_out=plugins=grpc:golpje/ golpje.proto

log "updating dependencies"
go get -u -d .
log "building"
mkdir -p dist
go build -o dist/golpje *.go
if [[ $? -ne 0 ]]; then
   echo "Build failed, stopping now"
   exit 0
fi

if [[ $1 = "release" ]]; then
    git fetch --tags
    GIT_TAG="$(git describe --always --tags $(git rev-list --tags --max-count=1))"
    for arch in amd64 x86 arm; do
        go build -o dist/golpje-linux-${arch}-${GIT_TAG} *.go
    done
    exit 0
fi

log "starting"
echo '---------------------------------'
echo
dist/golpje ${@}
